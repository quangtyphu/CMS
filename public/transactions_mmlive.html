<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Qu·∫£n L√Ω Thi·∫øt B·ªã</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { margin-bottom: 15px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #3498db; color: #fff; }
    input { padding: 5px; }
    select { padding: 5px; }
    button { padding: 6px 12px; margin-top: 5px; }
    #transactionTable input[type="number"] {
      width: 90px;
      box-sizing: border-box;
    }

    /* T·ªïng c∆∞·ª£c (ƒë√£ c√≥) */
    .editable-number {
      border-bottom: 1px dashed #3498db;  /* g·∫°ch ch√¢n xanh */
      color: #3498db;
      cursor: pointer;
      padding: 2px 4px;
      display: inline-block;
      min-width: 50px;
      text-align: center;
    }

    /* Th√™m cho Thi·∫øt b·ªã & ƒê√£ c∆∞·ª£c */
    .editable-device,
    .editable-currentbet {
      border-bottom: 1px dashed #3498db;  /* g·∫°ch ch√¢n xanh */
      color: #3498db;
      cursor: pointer;
      padding: 2px 4px;
      display: inline-block;
      min-width: 50px;
      text-align: center;
    }

    .editable-input {
      width: 70px;
      text-align: center;
    }
    .status-select.playing {
      background-color: #2ecc71; /* xanh l√° */
      color: white;
      font-weight: bold;
    }
    #refreshBtn {
      background-color: #3498db;  /* xanh d∆∞∆°ng */
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin-bottom: 15px;
    }
    .game-option {
      padding: 5px 10px;
      cursor: pointer;
      display: block;
      color: #333;
    }
    .status-select.done {
      background-color: #e74c3c; /* ƒë·ªè */
      color: white;
      font-weight: bold;
    }

    .game-option:hover {
      background: #3498db;
      color: #fff;
    }

    #refreshBtn:hover {
      background-color: #2980b9; /* xanh ƒë·∫≠m h∆°n khi hover */
    }

  </style>
</head>
<body>
  <h2>Qu·∫£n L√Ω Giao D·ªãch</h2>
  <button id="refreshBtn" onclick="location.reload()">üîÑ Refresh</button>
  <table id="transactionTable">
    <thead>
      <tr>
        <th>T√™n ƒëƒÉng nh·∫≠p</th>
        <th style="position: relative;">
          Game 
          <!-- <span id="gameFilterWrapper" style="position: relative; display: inline-block; margin-left: 4px;">
            <span id="gameFilterIcon" style="cursor:pointer;">‚öôÔ∏è</span>
            <div id="gameFilterMenu" 
                style="display:none; position:absolute; top:20px; left:0; background:#fff; border:1px solid #ccc; padding:5px; z-index:1000;">
              <div class="game-option" data-value="">T·∫•t c·∫£</div>
              <div class="game-option" data-value="MMLIVE">MMLIVE</div>
              <div class="game-option" data-value="LC79">LC79</div>
            </div>
          </span> -->
        </th>
        <th>Ng√¢n h√†ng / STK</th>
        <th>Thi·∫øt b·ªã</th>
        <th>T·ªïng n·∫°p</th>
        <th>T·ªïng r√∫t</th>
        <th>N·∫°p Ng√†y</th>
        <th>N·∫°p Tu·∫ßn</th>
        <th>R√∫t Ng√†y</th>
        <th>R√∫t Tu·∫ßn</th>
        <th>T·ªïng C∆∞·ª£c</th>
        <th>ƒê√£ c∆∞·ª£c</th>
        <th>N·∫°p Ti·ªÅn</th>
        <th>R√∫t ti·ªÅn</th>
        <th>Tr·∫°ng th√°i</th>
      </tr>
    </thead>

    <tbody></tbody>
  </table>
  </table>

  <!-- ===== B·∫¢NG L·ªäCH S·ª¨ GIAO D·ªäCH ===== -->
  <h2>L·ªãch S·ª≠ Giao D·ªãch</h2>
  <table id="historyTable">
    <thead>
      <tr>
        <th>T√™n ƒëƒÉng nh·∫≠p</th>
        <th>Thi·∫øt b·ªã</th>
        <th>S·ªë ti·ªÅn</th>
        <th>H√¨nh th·ª©c</th>
        <th>Th·ªùi gian</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
<script>
  // ================== T·∫¢I DANH S√ÅCH DEVICE ==================
  let allDevices = [];
  async function loadDevices() {
    try {
      const res = await fetch("/api/device-balances");
      allDevices = await res.json();
      console.log("üì¶ Devices ƒë√£ load:", allDevices);
    } catch (err) {
      console.error("L·ªói khi load devices:", err);
      allDevices = [];
    }
  }

  // ================== T·∫¢I DANH S√ÅCH T√ÄI KHO·∫¢N ==================
  let selectedGame = "MMLIVE";
  async function loadTransactions() {
    const res = await fetch("/api/accounts/with-stats");
    const data = await res.json();
    const tbody = document.querySelector("#transactionTable tbody");
    tbody.innerHTML = "";

    data
      .filter(tran => !selectedGame || (tran.game || '').toUpperCase() === selectedGame)
      .forEach(tran => {
        tbody.innerHTML += `
          <tr>
            <td>${tran.username}</td>
            <td>${tran.game || ''}</td>
            <td>${(tran.bank || '') + (tran.bank && tran.accountNumber ? ' / ' : '') + (tran.accountNumber || '')}</td>
            <td>
              <span class="editable-device" data-username="${tran.username}">
                ${tran.device || '---'}
              </span>
            </td>
            <td>${tran.totalDeposit}</td>
            <td>${tran.totalWithdraw}</td>
            <td>${tran.todayDeposit || 0}</td>
            <td>${tran.weekDeposit || 0}</td>
            <td>${tran.todayWithdraw || 0}</td>
            <td>${tran.weekWithdraw || 0}</td>
            <td>
              <span class="editable-number" data-username="${tran.username}">
                ${tran.totalBet || 0}
              </span>
            </td>
            <td>
              <span class="editable-currentbet" data-username="${tran.username}">
                ${tran.currentBet || 0}
              </span>
            </td>
            <td>
              <select id="depositDevice-${tran.username}" class="device-select">
                <option value="">--Device--</option>
              </select>
              <input type="number" id="deposit-${tran.username}" placeholder="Nh·∫≠p s·ªë">
              <button onclick="deposit('${tran.username}')">Nh·∫≠p</button>
            </td>
            <td>
              <input type="number" id="withdraw-${tran.username}" placeholder="Nh·∫≠p s·ªë">
              <button onclick="withdraw('${tran.username}')">Nh·∫≠p</button>
            </td>
            <td>
              <select 
                class="status-select 
                  ${tran.status === "ƒêang Ch∆°i" ? "playing" : ""} 
                  ${tran.status === "Xong" ? "done" : ""}" 
                onchange="updateStatus('${tran.username}', this.value)">
                <option ${tran.status === "ƒêang Ch∆°i" ? "selected" : ""}>ƒêang Ch∆°i</option>
                <option ${tran.status === "ƒê√£ N·∫°p" ? "selected" : ""}>ƒê√£ N·∫°p</option>
                <option ${tran.status === "Ho√†n Th√†nh" ? "selected" : ""}>Ho√†n Th√†nh</option>
                <option ${tran.status === "Ch∆∞a Xong" ? "selected" : ""}>Ch∆∞a Xong</option>
                <option ${tran.status === "Ch·ªù R√∫t" ? "selected" : ""}>Ch·ªù R√∫t</option>
                <option ${tran.status === "Xong" ? "selected" : ""}>Xong</option>
                <option ${tran.status === "Xong Tu·∫ßn" ? "selected" : ""}>Xong Tu·∫ßn</option>
                <option ${tran.status === "OFF" ? "selected" : ""}>OFF</option>
              </select>
            </td>
          </tr>
        `;

        // üìå G·∫ÆN DANH S√ÅCH DEVICE V√ÄO SELECT C·ª¶A D√íNG N√ÄY
        setTimeout(() => {
          const sel = document.getElementById(`depositDevice-${tran.username}`);
          if (sel) {
            sel.innerHTML = '<option value="">--Device--</option>';
            allDevices.forEach(d => {
              const opt = document.createElement('option');
              opt.value = d.device;
              opt.textContent = `${d.device} (${d.balance?.toLocaleString('vi-VN')} ƒë)`;
              sel.appendChild(opt);
            });
          }
        }, 0);
      });
  }

  // ================== C·∫¨P NH·∫¨T T·ªîNG C∆Ø·ª¢C ==================
  async function TotalBet(username) {
    const amount = parseInt(document.getElementById(`TotalBet-${username}`)?.value, 10);
    if (!amount) return;
    await fetch("/api/accounts/TotalBet", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, amount })
    });
    loadTransactions();
  }

  // ================== N·∫†P TI·ªÄN ==================
  async function deposit(username) {
    const amount = parseInt(document.getElementById(`deposit-${username}`).value, 10);
    const fromDevice = document.getElementById(`depositDevice-${username}`).value;
    if (!amount || !fromDevice) {
      alert("Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn v√† ch·ªçn Device n·∫°p");
      return;
    }
    await fetch("/api/accounts/deposit", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, amount, fromDevice })
    });
    await loadDevices();      // üîÅ c·∫≠p nh·∫≠t l·∫°i s·ªë d∆∞ device m·ªõi nh·∫•t
    loadTransactions();
    loadHistory();
  }

  // ================== R√öT TI·ªÄN ==================
  async function withdraw(username) {
    const amount = parseInt(document.getElementById(`withdraw-${username}`).value, 10);
    if (!amount) return;
    await fetch("/api/accounts/withdraw", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, amount })
    });
    loadTransactions();
    loadHistory();
  }

  // ================== C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI ==================
  async function updateStatus(username, status) {
    await fetch("/api/accounts/status", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, status })
    });
    loadTransactions();
  }

// ================== L·ªäCH S·ª¨ GIAO D·ªäCH ==================
async function loadHistory() {
  // L·∫•y to√†n b·ªô account ƒë·ªÉ bi·∫øt game c·ªßa t·ª´ng username
  const accRes = await fetch("/api/accounts/with-stats");
  const accounts = await accRes.json();
  const accountMap = {};
  accounts.forEach(acc => {
    accountMap[acc.username] = (acc.game || '').toUpperCase();
  });

  // L·∫•y l·ªãch s·ª≠ giao d·ªãch
  const res = await fetch("/api/transactions/all?limit=40&page=1");
  const json = await res.json();
  const data = json.data;

  const tbody = document.querySelector("#historyTable tbody");
  tbody.innerHTML = "";

  data
    // ch·ªâ hi·ªÉn th·ªã c√°c username c√≥ game kh·ªõp v·ªõi selectedGame
    .filter(txn => accountMap[txn.username] === selectedGame)
    .forEach(txn => {
      tbody.innerHTML += `
        <tr>
          <td>${txn.username}</td>
          <td>${txn.device || '---'}</td>
          <td>${txn.amount}</td>
          <td>${txn.type === 'deposit' ? 'N·∫°p ti·ªÅn' : 'R√∫t ti·ªÅn'}</td>
          <td>${txn.time}</td>
        </tr>
      `;
    });
}


  // Cho ph√©p click ƒë·ªÉ ch·ªânh s·ª≠a TotalBet v√† CurrentBet
document.addEventListener("click", function(e) {
  if (e.target.classList.contains("editable-number")) {
    makeEditable(e.target, "/api/accounts/TotalBet", "totalBet");
  }
  if (e.target.classList.contains("editable-currentbet")) {
    makeEditable(e.target, "/api/accounts/CurrentBet", "currentBet");
  }
  // ‚úÖ Th√™m d√≤ng n√†y ƒë·ªÉ cho ph√©p s·ª≠a c·ªôt Thi·∫øt b·ªã
  if (e.target.classList.contains("editable-device")) {
    makeEditableText(e.target, "/api/accounts/device", "device");
  }
});

async function showTotalsMMLIVE() {
  try {
    const res = await fetch("/api/accounts/summary/MMLIVE");
    const data = await res.json();

    // T·∫°o/ghi ƒë√® √¥ hi·ªÉn th·ªã
    let summary = document.getElementById("mmlive-summary");
    if (!summary) {
      summary = document.createElement("div");
      summary.id = "mmlive-summary";
      document.body.prepend(summary);
    }

    summary.innerHTML = `
      <h3>üìä T·ªïng giao d·ªãch MMLIVE</h3>
      <p>üí∞ T·ªïng n·∫°p: <b>${data.totalDeposit.toLocaleString('vi-VN')} ƒë</b></p>
      <p>üí∏ T·ªïng r√∫t: <b>${data.totalWithdraw.toLocaleString('vi-VN')} ƒë</b></p>
    `;
  } catch (err) {
    console.error("L·ªói khi load t·ªïng MMLIVE:", err);
  }
}

function makeEditableText(span, apiUrl, field) {
  const username = span.dataset.username;
  const oldValue = span.innerText.trim();
  const input = document.createElement("input");
  input.type = "text";
  input.value = oldValue === '---' ? '' : oldValue;
  input.className = "editable-input";

  span.replaceWith(input);
  input.focus();

  input.addEventListener("blur", async () => {
    const value = input.value.trim();
    if (value) {
      try {
        const res = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, device: value })
        });
        if (!res.ok) throw new Error("C·∫≠p nh·∫≠t th·∫•t b·∫°i");
      } catch (err) {
        alert("‚ùå L·ªói: " + err.message);
      }
    }
    loadTransactions();
  });
}

function makeEditable(span, apiUrl, field) {
  const username = span.dataset.username;
  const oldValue = span.innerText.trim();
  const input = document.createElement("input");
  input.type = "number";
  input.value = oldValue;
  input.className = "editable-input";

  // thay span b·∫±ng input
  span.replaceWith(input);
  input.focus();

  input.addEventListener("blur", async () => {
    const value = parseInt(input.value, 10);
    if (!isNaN(value)) {
      // üîß ph√¢n nh√°nh ƒë√∫ng key g·ª≠i l√™n backend
      const body = (field === "currentBet")
        ? { username, currentBet: value }
        : { username, amount: value };

      try {
        const res = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        if (!res.ok) throw new Error("C·∫≠p nh·∫≠t th·∫•t b·∫°i");
      } catch (err) {
        alert("‚ùå L·ªói: " + err.message);
      }
    }
    loadTransactions();
  });
}


  // ================== FILTER GAME ==================
  // document.getElementById("gameFilterIcon").addEventListener("click", () => {
  //   const menu = document.getElementById("gameFilterMenu");
  //   menu.style.display = (menu.style.display === "block") ? "none" : "block";
  // });

  // document.querySelectorAll("#gameFilterMenu .game-option").forEach(opt => {
  //   opt.addEventListener("click", e => {
  //     selectedGame = e.target.dataset.value;
  //     document.getElementById("gameFilterMenu").style.display = "none";
  //     loadTransactions();
  //   });
  // });

  // document.addEventListener("click", (e) => {
  //   if (!document.getElementById("gameFilterWrapper").contains(e.target)) {
  //     document.getElementById("gameFilterMenu").style.display = "none";
  //   }
  // });

  // ================== CH·∫†Y KHI LOAD TRANG ==================
  (async () => {
    await loadDevices();
    await loadTransactions();
    await showTotalsMMLIVE();
    loadHistory();
  })();
</script>

</body>
</html>
