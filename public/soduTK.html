<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Quáº£n lÃ½ Device Balance</title>
  <style>
    .container { padding: 20px; }
    .section-title {
      font-size: 20px;
      font-weight: bold;
      margin: 20px 0 10px 0;
      color: #333;
    }
    .form-row { margin-bottom: 10px; }
    .form-row input {
      margin-right: 10px;
      padding: 6px;
      height: 34px;
      width: 200px;
      box-sizing: border-box;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      text-align: center;
    }
    .btn {
      padding: 6px 12px;
      background-color: #2ecc71;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
    }
    .btn:hover { background-color: #27ae60; }
    #deviceTable { width: 100%; border-collapse: collapse; margin-top:20px; }
    #deviceTable th, #deviceTable td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: center;
    }
    #deviceTable th { background-color: #3498db; color: #fff; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Form thÃªm/sá»­a -->
    <h2 class="section-title">ThÃªm / Cáº­p nháº­t Device</h2>
    <form id="deviceForm">
      <div class="form-row">
        <input type="text" id="device" placeholder="TÃªn Device" required>
        <input type="number" id="balance" placeholder="Sá»‘ dÆ°" required>
        <input type="text" id="bank" placeholder="NgÃ¢n hÃ ng">               <!-- ðŸ†• -->
        <input type="text" id="username" placeholder="TÃªn Ä‘Äƒng nháº­p">       <!-- ðŸ†• -->
        <input type="text" id="accountNumber" placeholder="STK ngÃ¢n hÃ ng">
        <input type="text" id="accountHolder" placeholder="Chá»§ tÃ i khoáº£n">
        <button type="submit" class="btn" id="submitBtn">ThÃªm Device</button>
      </div>
    </form>


    <hr>

    <!-- Danh sÃ¡ch device -->
    <h2 class="section-title">Danh sÃ¡ch Device</h2>
    <h3 id="totalBalanceDisplay">Tá»•ng sá»‘ dÆ°: 0 Ä‘</h3>
    <table id="deviceTable">
      <thead>
        <tr>
          <th>Device</th>
          <th>Sá»‘ dÆ°</th>
          <th>NgÃ¢n hÃ ng</th>        <!-- ðŸ†• -->
          <th>TÃªn Ä‘Äƒng nháº­p</th>
          <th>STK</th>
          <th>Chá»§ tÃ i khoáº£n</th>
          <th>Sá»­a</th>
          <th>XÃ³a</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
let isEditMode = false;
let editingDevice = '';

async function loadDevices() {
  const res = await fetch("/api/device-balances");
  const data = await res.json();
  const tbody = document.querySelector("#deviceTable tbody");
  tbody.innerHTML = "";

  let totalBalance = 0; // ðŸ†• táº¡o biáº¿n tá»•ng

  data.forEach(item => {
    totalBalance += item.balance || 0; // ðŸ†• cá»™ng dá»“n
    tbody.innerHTML += `
      <tr>
        <td>${item.device || ""}</td>
        <td>${(item.balance || 0).toLocaleString('vi-VN')} Ä‘</td>
        <td>${item.bank || ""}</td>
        <td>${item.username || ""}</td>
        <td>${item.accountNumber || ""}</td>
        <td>${item.accountHolder || ""}</td>
        <td><button class="btn edit-btn" data-device="${item.device}">Sá»­a</button></td>
        <td><button class="btn delete-btn" data-device="${item.device}">XÃ³a</button></td>
      </tr>
    `;
  });

  // ðŸ†• hiá»ƒn thá»‹ tá»•ng sá»‘ dÆ° ra tháº» h3 Ä‘Ã£ táº¡o
  document.getElementById("totalBalanceDisplay").textContent =
    "Tá»•ng sá»‘ dÆ°: " + totalBalance.toLocaleString('vi-VN') + " Ä‘";
}

function readForm() {
  return {
    device: document.getElementById("device").value,
    balance: Number(document.getElementById("balance").value),
    bank: document.getElementById("bank").value,             // ðŸ†• thÃªm
    username: document.getElementById("username").value,     // ðŸ†• thÃªm
    accountNumber: document.getElementById("accountNumber").value,
    accountHolder: document.getElementById("accountHolder").value
  };
}

function fillForm(item) {
  document.getElementById("device").value = item.device || "";
  document.getElementById("balance").value = item.balance || 0;
  document.getElementById("bank").value = item.bank || "";               // ðŸ†•
  document.getElementById("username").value = item.username || "";       // ðŸ†•
  document.getElementById("accountNumber").value = item.accountNumber || "";
  document.getElementById("accountHolder").value = item.accountHolder || "";
}

function resetForm() {
  document.getElementById("deviceForm").reset();
  isEditMode = false;
  editingDevice = '';
  document.getElementById("submitBtn").textContent = "ThÃªm Device";
}
document.getElementById("deviceForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const payload = readForm();

  if (isEditMode && editingDevice) {
    // âœ… Update device
    await fetch(`/api/device-balances/${editingDevice}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
  } else {
    // âœ… ThÃªm má»›i device
    await fetch("/api/device-balances", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
  }

  resetForm();
  loadDevices();
});


document.addEventListener("click", async (e) => {
  // XÃ“A
  if (e.target.classList.contains("delete-btn")) {
    const device = e.target.dataset.device;
    if (confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a device nÃ y?")) {
      await fetch(`/api/device-balances/${device}`, { method: "DELETE" });
      loadDevices();
    }
  }

  // Sá»¬A
  if (e.target.classList.contains("edit-btn")) {
    const device = e.target.dataset.device;
    const res = await fetch(`/api/device-balances/${device}`);
    const item = await res.json();

    fillForm(item);
    isEditMode = true;
    editingDevice = device;
    document.getElementById("submitBtn").textContent = "Cáº­p nháº­t";
  }
});

loadDevices();
</script>

</body>
</html>
