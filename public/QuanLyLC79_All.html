<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard LC79</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --blue:#3498db; --green:#2ecc71; --red:#e74c3c; --gray:#f7f8fa; }
    body{font-family:Arial, sans-serif; background:var(--gray); margin:0; padding:20px;}
    h2{margin:0 0 12px;}
    button{padding:4px 8px; border:none; border-radius:4px; background:var(--blue); color:#fff; cursor:pointer; font-size:12px;}
    button:hover{background:#2980b9;}
    .cancel-btn{background:var(--red);} .cancel-btn:hover{background:#c0392b;}
    table{width:100%; border-collapse:collapse; background:#fff; border-radius:10px; overflow:hidden;}
    th, td{border:1px solid #eee; padding:8px; text-align:center; font-size:14px;}
    th{background:var(--blue); color:#fff; position:sticky; top:0; z-index:1;}
    .muted{color:#888;}
    .editable-device{border-bottom:1px dashed var(--blue); color:var(--blue); cursor:pointer; display:inline-block; min-width:60px;}
    .editable-input{width:120px; text-align:center;}
    .status-select.playing{background:var(--green); color:#fff; font-weight:bold;}
    .status-select.done{background:var(--red); color:#fff; font-weight:bold;}
    .right{text-align:right;}
    .nowrap{white-space:nowrap;}
    .bank{font-weight:600;}
    .device-action{display:flex; gap:4px; justify-content:center; align-items:center;}
    .device-action select{font-size:13px; padding:2px 4px;}
    #pagination { margin-top:10px; text-align:center; }
    #pagination button { margin:0 4px; }
    #pagination button.active { background:var(--green); }
    #refreshBtn {
      display: block;
      width: 160px;
      margin: 10px 0;
      padding: 10px;
      font-size: 16px;
      border-radius: 6px;
      position: fixed;
      top: 20px;
      right: 30px;
      z-index: 9999;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      opacity: 0.95;
    }
    /* accounts pagination */
    #accountsPagination { margin-top:10px; text-align:center; }
    #accountsPagination button { margin:0 4px; }
    #accountsPagination button.active { background:var(--green); }
    .small-muted { font-size:12px; color:#666; margin-left:8px; }

    /* Action buttons */
    button.btn-check {
      padding: 4px 8px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
    }

    button.btn-check:hover {
      background: #2980b9;
    }

    button.btn-deposit {
      padding: 4px 8px;
      background: #2ecc71;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
    }

    button.btn-deposit:hover {
      background: #27ae60;
    }

    button.btn-withdraw {
      padding: 4px 8px;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
    }

    button.btn-withdraw:hover {
      background: #c0392b;
    }
  </style>
</head>
<body>

  <h2>Dashboard ‚Äì Game LC79</h2>

  <!-- ‚úÖ Box t·ªïng h·ª£p -->
  <div id="summaryBox" style="margin:12px 0; font-weight:bold; font-size:15px; background:#fff; padding:10px; border-radius:8px;">
    <p>T·ªïng N·∫°p: <span id="sumDeposit">0</span></p>
    <p>T·ªïng R√∫t: <span id="sumWithdraw">0</span></p>
    <p>S·ªë D∆∞: <span id="sumBalance">0</span></p>
    <p>L·ª£i Nhu·∫≠n: <span id="sumProfit">0</span></p>
    <p>T·ªïng C∆∞·ª£c Ng√†y: <span id="sumTotalDay">0</span></p>
  </div>

  <button id="refreshBtn" onclick="refreshData()">üîÑ Refresh</button>

  <!-- th√™m controls ph√¢n trang cho b·∫£ng ch√≠nh -->
  <div style="display:flex; justify-content:space-between; align-items:center; margin:8px 0;">
    <div>
      <label>Hi·ªÉn th·ªã: <strong>15</strong> d√≤ng / trang</label>
      <span class="small-muted"> (b·∫£ng t√†i kho·∫£n)</span>
    </div>
    <div id="accountsPagination" aria-label="Accounts pagination"></div>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th>Game</th>
        <th>Username</th>
        <th>NickName</th>
        <th>Balance</th>
        <th>T·ªïng C∆∞·ª£c Ng√†y</th>
        <th>T·ªïng C∆∞·ª£c Tu·∫ßn</th>
        <th>T·ªïng C∆∞·ª£c Th√°ng</th>
        <th>T·ªïng N·∫°p</th>
        <th>T·ªïng R√∫t</th>
        <th>Ng√¢n h√†ng v√† STK</th>
        <th>Thi·∫øt B·ªã</th>
        <th>Proxy</th>
        <th>Access Token</th>
        <th>N·∫°p Ng√†y</th>
        <th>R√∫t Ng√†y</th>
        <th>ƒêu D√¢y</th>
        <th>Action</th>
        <th>Tr·∫°ng Th√°i</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>


<script>
// H√†m refresh gi·ªØ nguy√™n v·ªã tr√≠ cu·ªôn
function refreshData() {
  const scrollY = window.scrollY;
  init().then(() => {
    window.scrollTo({ top: scrollY });
  });
}
const fmt = n => (Number(n||0)).toLocaleString('vi-VN');

let profileMap = {};
let allDevices = [];
let historyData = [];
let userMap = {};
let totalsByUser = {}; // { username: { deposit, withdraw } }



// ====== Ph√¢n trang cho b·∫£ng t√†i kho·∫£n (m·ªõi) ======
let currentAccountPage = 1;
const accountPageSize = 60; // <- m·ªói trang 15 d√≤ng nh∆∞ b·∫°n y√™u c·∫ßu

// ================= INIT =================
async function init() {
  await loadProfiles();
  await loadDevices();
  await loadTotalsByUser();      // üÜï l·∫•y t·ªïng n·∫°p/r√∫t theo user t·ª´ backend (GROUP BY)
  await loadHistory();           // ch·ªâ ƒë·ªÉ hi·ªÉn th·ªã b·∫£ng l·ªãch s·ª≠ (kh√¥ng d√πng ƒë·ªÉ t√≠nh t·ªïng)
  await loadAccountsWithStats(); // render b·∫£ng ch√≠nh (b√¢y gi·ªù c√≥ ph√¢n trang)
}

// ================= LOAD PROFILES =================
async function loadProfiles() {
  try {
    const res = await fetch('/api/users');
    const arr = await res.json();
    profileMap = {};
    arr.forEach(p=>{
      profileMap[p.username] = { nickname: p.nickname || '', balance: Number(p.balance||0) };
    });
  } catch (e) {
    console.error('L·ªói load profiles:', e);
    profileMap = {};
  }
}

// ================= LOAD DEVICES =================
async function loadDevices() {
  try {
    const res = await fetch("/api/device-balances");
    allDevices = await res.json();
  } catch (err) {
    console.error("L·ªói khi load devices:", err);
    allDevices = [];
  }
}

// ================= LOAD TOTALS BY USER (API m·ªõi) =================
async function loadTotalsByUser() {
  try {
    const res = await fetch('/api/transactions/grouped/by-user');
    if (!res.ok) throw new Error('Kh√¥ng l·∫•y ƒë∆∞·ª£c t·ªïng n·∫°p/r√∫t');
    totalsByUser = await res.json() || {};
  } catch (e) {
    console.error('L·ªói loadTotalsByUser:', e);
    totalsByUser = {};
  }
}

// ================= LOAD ACCOUNTS + attach stats =================
async function loadAccountsWithStats() {
  try {
    const resAcc = await fetch('/api/accounts');
    const accounts = await resAcc.json();

    const resUsers = await fetch('/api/users');
    const users = await resUsers.json();

    // const resBets = await fetch('/api/bet-history/stats/lc79/users');
    // const betStats = await resBets.json();
    // => b·∫±ng ƒëo·∫°n sau ƒë·ªÉ l·∫•y t·ª´ bet_totals

    const resBets = await fetch('/api/bet-totals?page=1&limit=10000');
    const betResp = await resBets.json();
    const betRows = Array.isArray(betResp.data) ? betResp.data : (Array.isArray(betResp) ? betResp : []);
    const betMap = {};
    (betRows || []).forEach(s => {
      // bet_totals d√πng c√°c c·ªôt: username, total_day, total_week, total_month, total_all
      betMap[s.username] = {
        totalDay: Number(s.total_day || s.totalDay || 0),
        totalWeek: Number(s.total_week || s.totalWeek || 0),
        totalMonth: Number(s.total_month || s.totalMonth || 0),
        totalAll: Number(s.total_all || s.totalAll || 0)
      };
    });

    userMap = {};
    users.forEach(u => {
      userMap[u.username] = {
        status: u.status || "OFF Ng√†y",
        proxy: u.proxy || "",
        accessToken: u.accessToken || "",
        streak_win_today: 0,
        streak_lose_today: 0,
        streak_current_type: null,
        streak_current_len: 0
      };
    });

    // L·∫•y d·ªØ li·ªáu streaks t·ª´ API /streaks/batch cho c√°c account hi·ªán c√≥
    try {
      const usernames = Array.from(new Set((accounts || []).map(a => a.username).filter(Boolean)));
      if (usernames.length > 0) {
        const r = await fetch('/streaks/batch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ usernames })
        });
        if (r.ok) {
          const batch = await r.json(); // { username: {best_win_today,...}, ... }
          usernames.forEach(uname => {
            const s = batch[uname] || {};
            userMap[uname] = userMap[uname] || {};
            userMap[uname].streak_win_today = Number(s.best_win_today || 0);
            userMap[uname].streak_lose_today = Number(s.best_lose_today || 0);
            userMap[uname].streak_current_type = s.current_type || null;
            userMap[uname].streak_current_len = Number(s.current_len || 0);
          });
        }
      }
    } catch (e) {
      console.warn('Kh√¥ng l·∫•y ƒë∆∞·ª£c streaks batch:', e);
    }

    // N·∫°p ng√†y v·∫´n d·ª±a theo historyData (l·ªçc trong ng√†y)
    const todayDepositMap = buildTodayDepositMap();
    const todayWithdrawMap = buildTodayWithdrawMap();

    // G·∫Øn s·ªë li·ªáu v√†o accounts
    (accounts || []).forEach(acc => {
      acc.status = userMap[acc.username]?.status || "OFF Ng√†y";
      acc.proxy = userMap[acc.username]?.proxy || "";
      acc.accessToken = userMap[acc.username]?.accessToken || "";
      acc.totalBetDay = betMap[acc.username]?.totalDay || 0;
      acc.totalBetWeek = betMap[acc.username]?.totalWeek || 0;
      acc.totalBetMonth = betMap[acc.username]?.totalMonth || 0;
      acc.todayDeposit = todayDepositMap[acc.username] || 0;
      acc.todayWithdraw = todayWithdrawMap[acc.username] || 0;

      // ‚úÖ T·ªïng n·∫°p/r√∫t theo API GROUP BY (KH√îNG c√≤n ph·ª• thu·ªôc 100 b·∫£n ghi)
      acc.totalDeposit = totalsByUser[acc.username]?.deposit || 0;
      acc.totalWithdraw = totalsByUser[acc.username]?.withdraw || 0;
    });

    renderTable(accounts || []);
  } catch (err) {
    console.error("L·ªói khi load accounts:", err);
    renderTable([]);
  }
}




// ========== MODAL N·∫†P TI·ªÄN ==========
function openDepositModal(username) {
  console.log('üîç openDepositModal ƒë∆∞·ª£c g·ªçi cho user:', username);
  
  const amount = prompt(`Nh·∫≠p s·ªë ti·ªÅn n·∫°p cho user ${username}:`, '200000');
  console.log('üí∞ S·ªë ti·ªÅn nh·∫≠p:', amount);
  if (!amount || amount <= 0) {
    console.log('‚ùå S·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá');
    return;
  }
  deposit(username, amount);
}

async function deposit(username, amount) {
  console.log('üì§ B·∫Øt ƒë·∫ßu n·∫°p ti·ªÅn:', { username, amount });
  
  try {
    const payload = { username, amount: Number(amount) };
    console.log('üì¶ Payload g·ª≠i ƒëi:', payload);
    
    const res = await fetch('http://127.0.0.1:8080/api/deposit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    console.log('üì• Response status:', res.status);
    const data = await res.json();
    console.log('üì• Response data:', data);

    if (!res.ok) {
      console.error('‚ùå API tr·∫£ v·ªÅ l·ªói:', data);
      alert(`‚ùå L·ªói n·∫°p ti·ªÅn: ${data.error || 'Unknown error'}`);
      return;
    }

    console.log('‚úÖ Nh·∫≠n d·ªØ li·ªáu n·∫°p ti·ªÅn th√†nh c√¥ng!');
    
    // Hi·ªÉn th·ªã QR modal
    if (data.ok && data.data) {
      showQRModal(data);
    } else {
      alert(`‚úÖ N·∫°p ti·ªÅn th√†nh c√¥ng!\n${data.message || JSON.stringify(data, null, 2)}`);
    }
    
    loadAccountsWithStats(); // Refresh b·∫£ng
  } catch (err) {
    console.error('‚ùå L·ªói khi n·∫°p ti·ªÅn:', err);
    alert('‚ùå L·ªói khi n·∫°p ti·ªÅn: ' + err.message);
  }
}

// Hi·ªÉn th·ªã modal QR code
function showQRModal(data) {
  const qrData = data.data;
  
  console.log('üñºÔ∏è QR Data:', qrData);
  
  // T·∫°o modal
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  `;
  
  const content = document.createElement('div');
  content.style.cssText = `
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.3);
    max-width: 500px;
    text-align: center;
  `;
  
  // ∆Øu ti√™n: qr_link (URL) > qr_base64 > qr
  let qrImageSrc = qrData.qrLink || qrData.qr_link || '';
  
  // N·∫øu kh√¥ng c√≥ link, d√πng base64
  if (!qrImageSrc) {
    const base64Data = qrData.qr_base64 || qrData.qrBase64 || qrData.qr;
    if (base64Data) {
      qrImageSrc = `data:image/png;base64,${base64Data}`;
    }
  }
  
  console.log('üñºÔ∏è QR Image Source:', qrImageSrc);
  
  content.innerHTML = `
    <h2 style="margin-top:0; color:#2ecc71;">‚úÖ ${data.message || 'T·∫°o l·ªánh n·∫°p ti·ªÅn th√†nh c√¥ng'}</h2>
    
    <div style="background:#f8f9fa; padding:20px; border-radius:10px; margin:20px 0;">
      <h3 style="margin-top:0;">Th√¥ng tin chuy·ªÉn kho·∫£n</h3>
      <p style="margin:8px 0;"><strong>üéÆ User:</strong> ${qrData.username || 'N/A'}</p>
      <p style="margin:8px 0;"><strong>üë§ T√™n TK:</strong> ${qrData.name || qrData.accountHolder || 'N/A'}</p>
      <p style="margin:8px 0;"><strong>üè¶ S·ªë TK:</strong> ${qrData.receiver || qrData.accountNumber || 'N/A'}</p>
      <p style="margin:8px 0;"><strong>üí∞ S·ªë ti·ªÅn:</strong> ${Number(qrData.amount || 0).toLocaleString('vi-VN')} ƒë</p>
      <p style="margin:8px 0;"><strong>üìù N·ªôi dung:</strong> <span style="color:#e74c3c; font-weight:bold;">${qrData.msg || qrData.transferContent || 'N/A'}</span></p>
    </div>
    
    <div style="margin:20px 0;">
      ${qrImageSrc ? `
        <img src="${qrImageSrc}" alt="QR Code" 
          style="max-width:300px; width:100%; border:2px solid #ddd; border-radius:8px;" 
          onerror="console.error('L·ªói load QR:', this.src); this.style.display='none'; this.nextElementSibling.style.display='block';">
      ` : ''}
      <div style="display:${qrImageSrc ? 'none' : 'block'}; padding:40px; background:#f8d7da; color:#721c24; border-radius:8px;">
        ‚ùå Kh√¥ng th·ªÉ t·∫£i m√£ QR<br>
        <small>Vui l√≤ng chuy·ªÉn kho·∫£n theo th√¥ng tin b√™n tr√™n</small>
      </div>
    </div>
    
    <p style="color:#7f8c8d; font-size:13px;">Vui l√≤ng qu√©t m√£ QR ho·∫∑c chuy·ªÉn kho·∫£n theo th√¥ng tin tr√™n</p>
    <p style="color:#e74c3c; font-size:12px;">‚è∞ H·∫øt h·∫°n sau: <strong>${qrData.expired || 300}</strong> gi√¢y</p>
    
    <button onclick="this.closest('div').parentElement.remove()" style="
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
    ">ƒê√≥ng</button>
  `;
  
  modal.appendChild(content);
  document.body.appendChild(modal);
  
  // Click b√™n ngo√†i ƒë·ªÉ ƒë√≥ng
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      document.body.removeChild(modal);
    }
  });
}

// ========== MODAL R√öT TI·ªÄN ==========
function openWithdrawModal(username) {
  console.log('üîç openWithdrawModal ƒë∆∞·ª£c g·ªçi cho user:', username);
  
  // T·∫°o modal t√πy ch·ªânh v·ªõi c√°c button s·ªë ti·ªÅn
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  `;
  
  const content = document.createElement('div');
  content.style.cssText = `
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    max-width: 500px;
  `;
  
  content.innerHTML = `
    <h3 style="margin-top:0; margin-bottom:20px; text-align:center;">Ch·ªçn s·ªë ti·ªÅn r√∫t cho ${username}</h3>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
      <button class="withdraw-amount-btn" data-amount="100000" style="padding: 15px; font-size: 16px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">100K</button>
      <button class="withdraw-amount-btn" data-amount="200000" style="padding: 15px; font-size: 16px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">200K</button>
      <button class="withdraw-amount-btn" data-amount="300000" style="padding: 15px; font-size: 16px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">300K</button>
      <button class="withdraw-amount-btn" data-amount="500000" style="padding: 15px; font-size: 16px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">500K</button>
      <button class="withdraw-amount-btn" data-amount="600000" style="padding: 15px; font-size: 16px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">600K</button>
      <button class="withdraw-amount-btn" data-amount="800000" style="padding: 15px; font-size: 16px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">800K</button>
      <button class="withdraw-amount-btn" data-amount="1000000" style="padding: 15px; font-size: 16px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">1TR</button>
      <button class="withdraw-amount-btn" data-amount="2000000" style="padding: 15px; font-size: 16px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">2TR</button>
    </div>
    <button id="cancelWithdraw" style="width: 100%; padding: 10px; font-size: 14px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer;">H·ªßy</button>
  `;
  
  modal.appendChild(content);
  document.body.appendChild(modal);
  
  // X·ª≠ l√Ω click c√°c button s·ªë ti·ªÅn
  content.querySelectorAll('.withdraw-amount-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const amount = btn.getAttribute('data-amount');
      console.log('üí∞ Button s·ªë ti·ªÅn ƒë∆∞·ª£c click:', amount);
      document.body.removeChild(modal);
      withdraw(username, amount);
    });
    
    btn.addEventListener('mouseenter', (e) => {
      e.target.style.background = '#c0392b';
    });
    
    btn.addEventListener('mouseleave', (e) => {
      e.target.style.background = '#e74c3c';
    });
  });
  
  // X·ª≠ l√Ω n√∫t h·ªßy
  content.querySelector('#cancelWithdraw').addEventListener('click', () => {
    document.body.removeChild(modal);
  });
  
  // Click ra ngo√†i ƒë·ªÉ ƒë√≥ng
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      document.body.removeChild(modal);
    }
  });
}

async function withdraw(username, amount) {
  console.log('üì§ B·∫Øt ƒë·∫ßu r√∫t ti·ªÅn:', { username, amount });
  try {
    const payload = { username, amount: Number(amount) };
    console.log('üì¶ Payload g·ª≠i ƒëi:', payload);

    // G·ªçi API Flask m·ªõi (port 8080)
    const res = await fetch('http://127.0.0.1:8080/api/withdraw', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    console.log('üì• Response status:', res.status);
    const data = await res.json();
    console.log('üì• Response data:', data);

    if (!res.ok || !data.ok) {
      console.error('‚ùå API tr·∫£ v·ªÅ l·ªói:', data);
      alert(`‚ùå L·ªói r√∫t ti·ªÅn: ${data.error || data.message || 'Unknown error'}`);
      return;
    }

    console.log('‚úÖ ƒê√£ g·ª≠i y√™u c·∫ßu r√∫t ti·ªÅn!');
    alert(`‚úÖ ƒê√£ g·ª≠i y√™u c·∫ßu r√∫t ti·ªÅn cho ${username}!\n${data.message || ''}`);
    loadAccountsWithStats(); // Refresh b·∫£ng
  } catch (err) {
    console.error('‚ùå L·ªói khi r√∫t ti·ªÅn:', err);
    alert('‚ùå L·ªói khi r√∫t ti·ªÅn: ' + err.message);
  }
}

// ...existing code...
// ================= HELPERS =================
function bankCell(bank, accountNumber) {
  if (!bank && !accountNumber) return '<span class="muted">---</span>';
  if (bank && accountNumber) return `<span class="bank">${bank}</span> / <span>${accountNumber}</span>`;
  return `<span>${bank || accountNumber}</span>`;
}

function deviceEditable(username, value) {
  const safe = value || '---';
  return `<span class="editable-device" data-username="${username}">${safe}</span>`;
}

function statusSelect(username, status) {
  const valid = ['ƒêang Ch∆°i','Proxy L·ªói','Token L·ªói','H·∫øt Ti·ªÅn','OFF Ng√†y','M·ªõi T·∫°o','T·∫°m Ngh·ªâ','ƒê·ªß Ng√†y','ƒê·ªß Tu·∫ßn','ƒê·ªß Th√°ng'];
  const s = valid.includes(status) ? status : 'M·ªõi T·∫°o';
  const cls = [
    'status-select',
    (s === 'ƒêang Ch∆°i' ? 'playing' : ''),
    (['H·∫øt Ti·ªÅn', 'Proxy L·ªói', 'Token L·ªói'].includes(s) ? 'done' : '')
  ].join(' ');
  return `
    <select class="${cls}" data-username="${username}" onchange="updateStatus('${username}', this.value)">
      ${valid.map(o => `<option ${o===s ? 'selected' : ''}>${o}</option>`).join('')}
    </select>
  `;
}

// ================= RENDER MAIN TABLE =================
// B√¢y gi·ªù renderTable nh·∫≠n t·∫•t c·∫£ accounts, l·ªçc LC79, r·ªìi ph√¢n trang
function renderTable(rows) {
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = '';

  // L·ªçc LC79
  const filtered = (rows || []).filter(r => (r.game||'').toUpperCase() === 'LC79');

  // ƒë·∫£m b·∫£o currentAccountPage n·∫±m trong gi·ªõi h·∫°n
  const totalPages = Math.max(1, Math.ceil(filtered.length / accountPageSize));
  if (currentAccountPage > totalPages) currentAccountPage = totalPages;
  if (currentAccountPage < 1) currentAccountPage = 1;

  const start = (currentAccountPage - 1) * accountPageSize;
  const end = start + accountPageSize;
  const pageItems = filtered.slice(start, end);

  pageItems.forEach(r=>{
    const uname = r.username;
    const p = profileMap[uname] || {};
    tbody.insertAdjacentHTML('beforeend', `
      <tr style="background:${getRowColor(r.status)}">
        <td>${(r.game||'')}</td>
        <td class="nowrap">${uname}</td>
        <td>${p.nickname || ''}</td>
        <td class="right">${fmt(p.balance)}</td>
        <td class="right">${fmt(r.totalBetDay || 0)}</td>
        <td class="right">${fmt(r.totalBetWeek || 0)}</td>
        <td class="right">${fmt(r.totalBetMonth || 0)}</td>
        <td class="right">${fmt(r.totalDeposit)}</td>
        <td class="right">${fmt(r.totalWithdraw)}</td>
        <td>${bankCell(r.bank, r.accountNumber)}</td>
        <td>${deviceEditable(uname, r.device)}</td>
        <td>${proxyEditable(uname, r.proxy)}</td>
        <td>${tokenEditable(uname, r.accessToken)}</td>
        <td class="right">${fmt(r.todayDeposit||0)}</td>
        <td class="right">${fmt(r.todayWithdraw||0)}</td>
        <td class="right">
          ${fmt(userMap[uname]?.streak_win_today || 0)}/
          ${fmt(userMap[uname]?.streak_lose_today || 0)}/
          ${fmt(userMap[uname]?.streak_current_len || 0)}
        </td>
        <td>
          <div style="display:flex; gap:4px; flex-wrap:wrap; justify-content:center;">
            <button class="btn-check" onclick="forceCheck('${uname}')">üîÑ Check</button>
            <button class="btn-deposit" onclick="openDepositModal('${uname}')">üí∞ N·∫°p</button>
            <button class="btn-withdraw" onclick="openWithdrawModal('${uname}')">üí∏ R√∫t</button>
          </div>
        </td>
        <td>${statusSelect(uname, r.status)}</td>
      </tr>
    `);
  });

  // c·∫≠p nh·∫≠t ph√¢n trang cho b·∫£ng accounts
  renderAccountsPagination(filtered.length, totalPages, currentAccountPage);

  renderSummary(rows);
}

function renderAccountsPagination(totalItems, totalPages, currentPageLocal) {
  const container = document.getElementById('accountsPagination');
  container.innerHTML = '';

  // n·∫øu kh√¥ng c·∫ßn ph√¢n trang th√¨ gi·ªØ tr·ªëng
  if (totalPages <= 1) {
    container.innerHTML = `<span class="small-muted">T·ªïng ${totalItems} t√†i kho·∫£n</span>`;
    return;
  }

  const firstBtn = document.createElement('button');
  firstBtn.innerText = '<<';
  firstBtn.disabled = currentPageLocal === 1;
  firstBtn.addEventListener('click', () => { currentAccountPage = 1; renderTableFromCurrent(); });
  container.appendChild(firstBtn);

  const prevBtn = document.createElement('button');
  prevBtn.innerText = '<';
  prevBtn.disabled = currentPageLocal === 1;
  prevBtn.addEventListener('click', () => { currentAccountPage = Math.max(1, currentAccountPage - 1); renderTableFromCurrent(); });
  container.appendChild(prevBtn);

  // show s·ªë trang (gi√£n n·∫øu qu√° nhi·ªÅu)
  const maxButtons = 7;
  let start = Math.max(1, currentPageLocal - Math.floor(maxButtons/2));
  let finish = Math.min(totalPages, start + maxButtons - 1);
  if (finish - start < maxButtons - 1) start = Math.max(1, finish - maxButtons + 1);

  for (let i = start; i <= finish; i++) {
    const b = document.createElement('button');
    b.innerText = i;
    if (i === currentPageLocal) b.classList.add('active');
    b.addEventListener('click', () => { currentAccountPage = i; renderTableFromCurrent(); });
    container.appendChild(b);
  }

  const nextBtn = document.createElement('button');
  nextBtn.innerText = '>';
  nextBtn.disabled = currentPageLocal === totalPages;
  nextBtn.addEventListener('click', () => { currentAccountPage = Math.min(totalPages, currentAccountPage + 1); renderTableFromCurrent(); });
  container.appendChild(nextBtn);

  const lastBtn = document.createElement('button');
  lastBtn.innerText = '>>';
  lastBtn.disabled = currentPageLocal === totalPages;
  lastBtn.addEventListener('click', () => { currentAccountPage = totalPages; renderTableFromCurrent(); });
  container.appendChild(lastBtn);

  // th√™m t·ªïng
  const info = document.createElement('span');
  info.className = 'small-muted';
  info.innerText = ` T·ªïng ${totalItems} t√†i kho·∫£n - Trang ${currentPageLocal}/${totalPages}`;
  container.appendChild(info);
}

function renderTableFromCurrent() {
  // loadAccountsWithStats s·∫Ω g·ªçi renderTable khi ho√†n t·∫•t; nh∆∞ng ·ªü ƒë√¢y ch√∫ng ta ƒë√£ c√≥ d·ªØ li·ªáu hi·ªán t·∫°i,
  // n√™n ch·ªâ g·ªçi l·∫°i renderTable v·ªõi d·ªØ li·ªáu hi·ªán c√≥: fetch l·∫°i /api/accounts ƒë·ªÉ ƒë·ªìng b·ªô t·ªët h∆°n.
  // Tuy nhi√™n ƒë·ªÉ ƒë∆°n gi·∫£n v√† nhanh, g·ªçi loadAccountsWithStats ƒë·ªÉ ƒë·∫£m b·∫£o m·ªçi d·ªØ li·ªáu c·∫≠p nh·∫≠t.
  loadAccountsWithStats();
}

// ================= SUMMARY (d√πng totalsByUser) =================
function renderSummary(rows) {
  try {
    // 1) T·ªïng n·∫°p/r√∫t to√†n h·ªá th·ªëng t·ª´ totalsByUser (ƒë√£ GROUP BY ·ªü backend)
    let sumDeposit = 0, sumWithdraw = 0;
    Object.values(totalsByUser).forEach(v => {
      sumDeposit  += Number(v?.deposit  || 0);
      sumWithdraw += Number(v?.withdraw || 0);
    });

    // 2) T·ªïng s·ªë d∆∞: c·ªông balance c·ªßa c√°c account LC79 ƒëang render (t·∫•t c·∫£, kh√¥ng ch·ªâ 1 trang)
    let sumBalance = 0;
    rows
      .filter(r => (r.game || '').toUpperCase() === 'LC79')
      .forEach(r => {
        sumBalance += Number(profileMap[r.username]?.balance || 0);
      });

    // 2b) T·ªïng c∆∞·ª£c ng√†y c·ªßa t·∫•t c·∫£ user (ch·ªâ t√≠nh cho LC79)
    let sumTotalDay = 0;
    rows
      .filter(r => (r.game || '').toUpperCase() === 'LC79')
      .forEach(r => { sumTotalDay += Number(r.totalBetDay || 0); });

    // 3) L·ª£i nhu·∫≠n = R√∫t + S·ªë D∆∞ - N·∫°p
    const profit = sumWithdraw + sumBalance - sumDeposit;

    // 4) C·∫≠p nh·∫≠t UI
    document.getElementById("sumDeposit").innerText  = sumDeposit.toLocaleString('vi-VN');
    document.getElementById("sumWithdraw").innerText = sumWithdraw.toLocaleString('vi-VN');
    document.getElementById("sumBalance").innerText  = sumBalance.toLocaleString('vi-VN');
    document.getElementById("sumProfit").innerText   = profit.toLocaleString('vi-VN');
    document.getElementById("sumTotalDay").innerText = (sumTotalDay || 0).toLocaleString('vi-VN');
  } catch (err) {
    console.error("L·ªói renderSummary:", err);
  }
}

// ================= EDITABLE CELLS =================
function proxyEditable(username, value) {
  const safe = value || '---';
  return `<span class="editable-proxy" data-username="${username}">${safe}</span>`;
}

function formatStreak(um) {
  const w = Number(um?.streak_win_today || 0);
  const l = Number(um?.streak_lose_today || 0);
  return `${w}/${l}`;
}
function getRowColor(status) {
  switch (status) {
    case 'H·∫øt Ti·ªÅn': return '#ffb3b3';     // ƒë·ªè nh·∫°t
    case 'ƒêang Ch∆°i': return '#b3ffcc';    // xanh nh·∫°t
    case 'Proxy L·ªói':
    case 'Token L·ªói': return '#ff6666';    // üî¥ ƒë·ªè ƒë·∫≠m
    case 'ƒê·ªß Ng√†y':   return '#e6ccff';      // üíú t√≠m nh·∫°t
    case 'ƒê·ªß Th√°ng':  return '#000000';    // üÜï M√ÄU ƒêEN
    case 'ƒê·ªß Tu·∫ßn':   return '#fff3b0';     // üåü v√†ng nh·∫°t
    default: return '#ffffff';              // tr·∫Øng
  }
}

function tokenEditable(username, value) {
  const safe = value || '---';
  return `<span class="editable-token" data-username="${username}">${safe}</span>`;
}

// ================= ACTIONS =================
async function confirmTxnDevice(transactionId) {
  const selectEl = document.getElementById(`txnDevice-${transactionId}`);
  const device = selectEl.value;
  if (!device) return alert("Vui l√≤ng ch·ªçn device");

  try {
    const res = await fetch(`/api/transactions/${transactionId}/device`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ device })
    });
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err?.error || "C·∫≠p nh·∫≠t thi·∫øt b·ªã th·∫•t b·∫°i");
    }

    // G·ªçi API tr·ª´ ti·ªÅn device (n·∫øu c√≥)
    await fetch(`/api/device-balances/${device}/deduct`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ amount: getTxnAmount(transactionId) })
    });

    await loadDevices();
    await loadHistory();
  } catch (e) {
    console.error(e);
    alert(e.message || "L·ªói khi c·∫≠p nh·∫≠t thi·∫øt b·ªã giao d·ªãch");
  }
}
//
function cancelTxnDevice() { loadHistory(); }

function getTxnAmount(transactionId) {
  const txn = historyData.find(t => t.transactionId === transactionId);
  return txn ? Number(txn.amount || 0) : 0;
}

async function updateStatus(username, status) {
  try {
    const res = await fetch(`/api/users/${username}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status })
    });
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err?.error || 'C·∫≠p nh·∫≠t tr·∫°ng th√°i th·∫•t b·∫°i');
    }
    await init();
  } catch (e) {
    console.error(e);
    alert(e.message || 'L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i');
  }
}

// ================= FORCE CHECK =================
async function forceCheck(username) {
  try {
    // G·ªçi API Flask m·ªõi
    const res = await fetch('http://127.0.0.1:8080/api/user-full-check', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username })
    });
    const data = await res.json();
    if (!res.ok || !data.ok) {
      showCheckUserModal('‚ùå L·ªói khi ki·ªÉm tra user: ' + (data.error || data.message || 'Unknown error'));
      return;
    }
    // Hi·ªÉn th·ªã k·∫øt qu·∫£ trong modal ƒë·∫πp
    showCheckUserModal('‚úÖ ƒê√£ ki·ªÉm tra user!', data.results);
    await init();
  } catch (err) {
    console.error('L·ªói khi user-full-check', err);
    showCheckUserModal('‚ùå L·ªói khi ki·ªÉm tra user: ' + err.message);
  }

// Modal hi·ªÉn th·ªã k·∫øt qu·∫£ check user
function showCheckUserModal(title, resultsObj) {
  // X√≥a modal c≈© n·∫øu c√≥
  const old = document.getElementById('checkUserModal');
  if (old) old.remove();

  const modal = document.createElement('div');
  modal.id = 'checkUserModal';
  modal.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.35); z-index: 99999; display: flex; align-items: center; justify-content: center;`
  ;
  const content = document.createElement('div');
  content.style.cssText = `
    background: #fff; border-radius: 12px; padding: 28px 24px 18px 24px; max-width: 520px; min-width: 320px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.18); max-height: 80vh; overflow: auto; position: relative;`
  ;
  content.innerHTML = `
    <div style="font-size:18px; font-weight:bold; margin-bottom:10px; color:#27ae60; display:flex; align-items:center; gap:8px;">
      <span>${title.startsWith('‚úÖ') ? '‚úÖ' : '‚ùå'}</span> <span>${title.replace(/^‚úÖ|^‚ùå/, '').trim()}</span>
    </div>
    <pre style="background:#f7f8fa; color:#222; font-size:14px; padding:14px 10px; border-radius:8px; max-height:55vh; overflow:auto; margin:0 0 12px 0;">${typeof resultsObj === 'object' ? JSON.stringify(resultsObj, null, 2) : resultsObj}</pre>
    <button id="closeCheckUserModalBtn" style="width:100%;padding:10px;font-size:16px;background:#3498db;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:bold;">ƒê√≥ng</button>
  `;
  modal.appendChild(content);
  document.body.appendChild(modal);
  // ƒê√≥ng khi b·∫•m n√∫t
  document.getElementById('closeCheckUserModalBtn').onclick = () => modal.remove();
  // ƒê√≥ng khi click ra ngo√†i
  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
}
}

// ================= L·ªäCH S·ª¨ GIAO D·ªäCH (ch·ªâ hi·ªÉn th·ªã) =================
async function loadHistory() {
  try {
    const res = await fetch("/api/transactions/all?limit=200&page=1");
    const data = await res.json();
    historyData = data.data || [];
    historyData.sort((a, b) => new Date(b.time) - new Date(a.time));
    renderHistoryPage(currentPage);
  } catch (err) {
    console.error("L·ªói khi load l·ªãch s·ª≠:", err);
  }
}

function buildTodayDepositMap() {
  const now = new Date();
  const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
  const endOfDay = startOfDay + 24 * 60 * 60 * 1000;
  const todayMap = {};

  historyData.forEach(txn => {
    if (txn.type === "N·∫°p ti·ªÅn") {
      const t = new Date(txn.time).getTime();
      if (t >= startOfDay && t < endOfDay) {
        todayMap[txn.username] = (todayMap[txn.username] || 0) + Number(txn.amount || 0);
      }
    }
  });

  return todayMap;
}
function buildTodayWithdrawMap() {
  const now = new Date();
  const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
  const endOfDay = startOfDay + 24 * 60 * 60 * 1000;
  const todayWithdrawMap = {};

  historyData.forEach(txn => {
    if (txn.type === "R√∫t ti·ªÅn") {
      const t = new Date(txn.time).getTime();
      if (t >= startOfDay && t < endOfDay) {
        todayWithdrawMap[txn.username] = (todayWithdrawMap[txn.username] || 0) + Number(txn.amount || 0);
      }
    }
  });

  return todayWithdrawMap;
}

async function updateTxnDevice(transactionId, device) {
  try {
    const res = await fetch(`/api/transactions/${transactionId}/device`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ device })
    });
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err?.error || 'C·∫≠p nh·∫≠t thi·∫øt b·ªã th·∫•t b·∫°i');
    }
    await loadHistory();
  } catch (e) {
    console.error(e);
    alert(e.message || 'L·ªói khi c·∫≠p nh·∫≠t thi·∫øt b·ªã giao d·ªãch');
  }
}

function renderHistoryPage(page) {
  const tbody = document.querySelector("#historyTable tbody");
  tbody.innerHTML = "";
  const start = (page - 1) * pageSize;
  const end = start + pageSize;
  const pageItems = historyData.slice(start, end);

  pageItems.forEach(txn => {
    let deviceCell = "";

    if (txn.type === "N·∫°p ti·ªÅn") {
      if (txn.device) {
        deviceCell = `<span>${txn.device}</span>`;
      } else {
        deviceCell = `
          <select id="txnDevice-${txn.transactionId}">
            <option value="">--Device--</option>
            ${allDevices.map(d => `
              <option value="${d.device}">
                ${d.device} (${(d.balance||0).toLocaleString('vi-VN')} ƒë)
              </option>
            `).join('')}
          </select>
          <button onclick="confirmTxnDevice('${txn.transactionId}')">‚úîÔ∏è</button>
          <button onclick="cancelTxnDevice('${txn.transactionId}')">‚ùå</button>
        `;
      }
    } else {
      deviceCell = `<span class="muted">---</span>`;
    }

    tbody.innerHTML += `
      <tr>
        <td>${txn.username}</td>
        <td>${txn.nickname || ''}</td>
        <td style="color:${txn.type === 'N·∫°p ti·ªÅn' ? 'red' : 'green'}; font-weight:bold;">
          ${txn.type}
        </td>
        <td class="right">${(txn.amount||0).toLocaleString('vi-VN')} ƒë</td>
        <td>${txn.transactionId || ''}</td>
        <td>${deviceCell}</td>
        <td>${txn.time}</td>
      </tr>
    `;
  });

  renderPagination();
}

function renderPagination() {
  const totalPages = Math.ceil(historyData.length / pageSize);
  const container = document.getElementById("pagination");
  container.innerHTML = "";
  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement("button");
    btn.innerText = i;
    if (i === currentPage) btn.classList.add("active");
    btn.addEventListener("click", () => {
      currentPage = i;
      renderHistoryPage(currentPage);
    });
    container.appendChild(btn);
  }
}

// ================= INLINE EDIT DEVICE =================
document.addEventListener('click', function(e) {
  if (!e.target.classList.contains('editable-device')) return;

  const span = e.target;
  const username = span.dataset.username;
  const oldValue = span.innerText.trim();

  const input = document.createElement('input');
  input.type = 'text';
  input.value = (oldValue === '---') ? '' : oldValue;
  input.className = 'editable-input';

  span.replaceWith(input);
  input.focus();

  input.addEventListener('blur', async () => {
    const device = input.value.trim();
    try {
      if (device) {
        await fetch('/api/accounts/device', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, device })
        });
      }
      await loadAccountsWithStats();
    } catch (err) {
      console.error("L·ªói khi c·∫≠p nh·∫≠t device:", err);
      alert("C·∫≠p nh·∫≠t thi·∫øt b·ªã th·∫•t b·∫°i!");
      await loadAccountsWithStats();
    }
  });
});

// ================= INLINE EDIT PROXY =================
document.addEventListener('click', function(e) {
  if (!e.target.classList.contains('editable-proxy')) return;
  const span = e.target;
  const username = span.dataset.username;
  const oldValue = span.innerText.trim();
  const input = document.createElement('input');
  input.type = 'text';
  input.value = (oldValue === '---') ? '' : oldValue;
  input.className = 'editable-input';
  span.replaceWith(input);
  input.focus();

  input.addEventListener('blur', async ()=>{
    const proxy = input.value.trim();
    await fetch('/api/users/proxy', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ username, proxy })
    });
    await loadAccountsWithStats();
  });
});

// ================= INLINE EDIT TOKEN =================
document.addEventListener('click', function(e) {
  if (!e.target.classList.contains('editable-token')) return;
  const span = e.target;
  const username = span.dataset.username;
  const oldValue = span.innerText.trim();
  const input = document.createElement('input');
  input.type = 'text';
  input.value = (oldValue === '---') ? '' : oldValue;
  input.className = 'editable-input';
  span.replaceWith(input);
  input.focus();

  input.addEventListener('blur', async ()=>{
    const accessToken = input.value.trim();
    await fetch('/api/users/accessToken', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ username, accessToken })
    });
    await loadAccountsWithStats();
  });
});

init();
</script>
</body>
</html>
