<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>T·ªïng C∆∞·ª£c LC79</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { margin-bottom: 15px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #2c3e50; color: #fff; }
    #refreshBtn {
      background-color: #3498db; color: #fff; border: none;
      padding: 8px 16px; border-radius: 5px; cursor: pointer; font-weight: bold;
      margin-bottom: 15px;
    }
    #refreshBtn:hover { background-color: #2980b9; }
  </style>
</head>
<body>
  <h2>üìä B·∫£ng T·ªïng C∆∞·ª£c Game LC79</h2>
  <!-- ‚úÖ g·ªçi ƒë√∫ng t√™n h√†m -->
  <button id="refreshBtn" onclick="loadStats()">üîÑ Refresh</button>

  <!-- T·ªïng c∆∞·ª£c ng√†y to√†n b·ªô users -->
  <div id="totalDaySummary" style="margin-top:10px; font-weight:bold;">T·ªïng C∆∞·ª£c Ng√†y: 0</div>

  <table id="lc79Table">
    <thead>
      <tr>
        <th>Username</th>
        <th>Nick Name</th>
        <th>T·ªïng Ng√†y</th>
        <th>T·ªïng Tu·∫ßn</th>
        <th>T·ªïng Th√°ng</th>
        <th>T·ªïng All</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="6">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
    </tbody>
  </table>

<script>
async function loadStats() {
  try {
    // L·∫•y t·∫•t c·∫£ b·∫£n ghi t·ª´ bet_totals
    const res = await fetch('/api/bet-totals?page=1&limit=10000');
    const json = await res.json();
    const rows = Array.isArray(json.data) ? json.data : (Array.isArray(json) ? json : []);

    // L·∫•y nickname t·ª´ user_profiles (ƒë·ªÉ hi·ªÉn th·ªã Nick Name)
    let nickMap = {};
    try {
      const ures = await fetch('/api/users');
      const users = await ures.json();
      users.forEach(u => { nickMap[u.username] = u.nickname || ''; });
    } catch (e) {
      // n·∫øu kh√¥ng l·∫•y ƒë∆∞·ª£c users th√¨ v·∫´n render th√¥i
      console.warn('Kh√¥ng l·∫•y ƒë∆∞·ª£c /api/users:', e);
    }

    const tbody = document.querySelector('#lc79Table tbody');
    tbody.innerHTML = "";

    if (!rows || rows.length === 0) {
      tbody.innerHTML = "<tr><td colspan='6'>Kh√¥ng c√≥ d·ªØ li·ªáu LC79</td></tr>";
      return;
    }

    // s·∫Øp x·∫øp theo t·ªïng all gi·∫£m d·∫ßn
    rows.sort((a, b) => (b.total_all || 0) - (a.total_all || 0));

    // t√≠nh t·ªïng ng√†y cho t·∫•t c·∫£ users
    const totalDayAll = rows.reduce((s, r) => s + Number(r.total_day || 0), 0);
    const totalDayEl = document.getElementById('totalDaySummary');
    if (totalDayEl) totalDayEl.textContent = `T·ªïng C∆∞·ª£c Ng√†y: ${totalDayAll.toLocaleString('vi-VN')}`;

    rows.forEach(it => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${it.username}</td>
        <td>${nickMap[it.username] || ''}</td>
        <td>${Number(it.total_day || 0).toLocaleString()}</td>
        <td>${Number(it.total_week || 0).toLocaleString()}</td>
        <td>${Number(it.total_month || 0).toLocaleString()}</td>
        <td><b>${Number(it.total_all || 0).toLocaleString()}</b></td>
      `;
      tbody.appendChild(row);
    });

  } catch (err) {
    console.error('L·ªói khi t·∫£i d·ªØ li·ªáu:', err);
    document.querySelector('#lc79Table tbody').innerHTML =
      "<tr><td colspan='6'>L·ªói khi t·∫£i d·ªØ li·ªáu</td></tr>";
  }
}
// t·∫£i l·∫ßn ƒë·∫ßu v√† t·ª± refresh m·ªói 30s
loadStats();
setInterval(loadStats, 30000);
</script>

</body>
</html>
